<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de An√°lise de Vendas</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #00512A 0%, #007C27 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        /* Header com bot√£o de atualiza√ß√£o */
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        h1 {
            color: #333;
            font-size: 2.5em;
            text-transform: uppercase;
            letter-spacing: 2px;
            flex: 1;
            min-width: 300px;
        }

        .refresh-container {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
        }

        .refresh-button {
            background: linear-gradient(135deg, #00512A 0%, #007C27 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 124, 39, 0.3);
        }

        .refresh-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 124, 39, 0.4);
        }

        .refresh-button:active {
            transform: translateY(0);
        }

        .refresh-button.loading {
            opacity: 0.7;
            cursor: wait;
        }

        .refresh-icon {
            font-size: 16px;
            transition: transform 0.5s;
        }

        .refresh-button.loading .refresh-icon {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .last-update {
            font-size: 11px;
            color: #666;
            font-style: italic;
        }

        /* Status de carregamento melhorado */
        #gsheets-debug {
            background: #F0F5CD;
            color: #00512A;
            border: 2px solid #007C27;
            padding: 12px 15px;
            border-radius: 10px;
            margin: 15px 0;
            font: 13px/1.5 system-ui, 'Segoe UI', Roboto;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #gsheets-debug.success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        #gsheets-debug.error {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        #gsheets-debug .status-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        h2 {
            color: #333;
            margin: 40px 0 20px 0;
            font-size: 1.8em;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 3px solid #007C27;
            padding-bottom: 10px;
        }

        .filters-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: #F0F5CD;
            border-radius: 10px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .filter-group label {
            font-weight: bold;
            margin-bottom: 8px;
            color: #555;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .picklist-container {
            position: relative;
        }

        .picklist-selected {
            padding: 10px 15px;
            border: 2px solid #F0F5CD;
            border-radius: 5px;
            background: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
            min-height: 42px;
        }

        .picklist-selected:hover {
            border-color: #007C27;
        }

        .picklist-selected.active {
            border-color: #007C27;
            box-shadow: 0 0 0 3px rgba(0, 124, 39, 0.12);
        }

        .picklist-text {
            flex: 1;
            color: #333;
            font-size: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .picklist-text.placeholder {
            color: #999;
        }

        .picklist-arrow {
            margin-left: 10px;
            color: #007C27;
            font-weight: bold;
            transition: transform 0.3s;
        }

        .picklist-arrow.open {
            transform: rotate(180deg);
        }

        .picklist-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 5px;
            background: white;
            border: 2px solid #007C27;
            border-radius: 5px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .picklist-dropdown.show {
            display: block;
        }

        .picklist-search {
            padding: 10px;
            border-bottom: 1px solid #F0F5CD;
            position: sticky;
            top: 0;
            background: white;
            z-index: 1;
        }

        .picklist-search input {
            width: 100%;
            padding: 8px;
            border: 1px solid #F0F5CD;
            border-radius: 4px;
            font-size: 13px;
        }

        .picklist-search input:focus {
            outline: none;
            border-color: #007C27;
        }

        .picklist-options {
            padding: 5px 0;
        }

        .picklist-option {
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: background 0.2s;
        }

        .picklist-option:hover {
            background: #F0F5CD;
        }

        .picklist-option input[type="checkbox"] {
            margin-right: 10px;
            cursor: pointer;
            width: 16px;
            height: 16px;
        }

        .picklist-option label {
            cursor: pointer;
            flex: 1;
            font-weight: normal;
            font-size: 14px;
            margin: 0;
            text-transform: none;
            letter-spacing: normal;
            color: #333;
        }

        .picklist-option.all {
            border-bottom: 1px solid #F0F5CD;
            background: #F0F5CD;
            font-weight: bold;
        }

        .picklist-count {
            background: #007C27;
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 5px;
        }

        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .card {
            background: linear-gradient(135deg, #00512A 0%, #007C27 100%);
            padding: 25px;
            border-radius: 15px;
            color: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }

        .card h3 {
            font-size: 1.2em;
            margin-bottom: 15px;
            opacity: 1;
            color: #F0F5CD;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .card .value {
            font-size: 2em;
            font-weight: bold;
            margin-top: 10px;
            color: #F0F5CD;
        }

        .card.meta {
            background: linear-gradient(135deg, #00512A 0%, #007C27 100%);
        }

        .table-container {
            overflow-x: auto;
            margin-top: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        thead {
            background: linear-gradient(135deg, #00512A 0%, #007C27 100%);
            color: white;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.9em;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        tr:hover {
            background: #F0F5CD;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 30px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        @media (max-width: 768px) {
            .header-container {
                flex-direction: column;
                align-items: stretch;
            }

            h1 {
                font-size: 1.8em;
                text-align: center;
            }

            .refresh-container {
                align-items: center;
            }

            .filters-container {
                grid-template-columns: 1fr;
            }

            .cards-container {
                grid-template-columns: 1fr;
            }

            .chart-container {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-container">
            <h1>Dashboard de An√°lise de Vendas</h1>
            <div class="refresh-container">
                <button class="refresh-button" onclick="manualRefresh()" id="refreshBtn">
                    <span class="refresh-icon">üîÑ</span>
                    <span>Atualizar Dados</span>
                </button>
                <div class="last-update" id="lastUpdate"></div>
            </div>
        </div>

        <div id="gsheets-debug"></div>

        <div class="filters-container">
            <div class="filter-group">
                <label>Ano:</label>
                <div class="picklist-container">
                    <div class="picklist-selected" onclick="togglePicklist('ano')">
                        <span class="picklist-text placeholder" id="ano-selected">Selecionar anos...</span>
                        <span class="picklist-arrow">‚ñº</span>
                    </div>
                    <div class="picklist-dropdown" id="ano-dropdown">
                        <div class="picklist-search">
                            <input type="text" placeholder="Buscar..." onkeyup="filterPicklist('ano')">
                        </div>
                        <div class="picklist-options" id="ano-options"></div>
                    </div>
                </div>
            </div>

            <div class="filter-group">
                <label>M√™s:</label>
                <div class="picklist-container">
                    <div class="picklist-selected" onclick="togglePicklist('mes')">
                        <span class="picklist-text placeholder" id="mes-selected">Selecionar meses...</span>
                        <span class="picklist-arrow">‚ñº</span>
                    </div>
                    <div class="picklist-dropdown" id="mes-dropdown">
                        <div class="picklist-search">
                            <input type="text" placeholder="Buscar..." onkeyup="filterPicklist('mes')">
                        </div>
                        <div class="picklist-options" id="mes-options"></div>
                    </div>
                </div>
            </div>

            <div class="filter-group">
                <label>Linha:</label>
                <div class="picklist-container">
                    <div class="picklist-selected" onclick="togglePicklist('linha')">
                        <span class="picklist-text placeholder" id="linha-selected">Selecionar linhas...</span>
                        <span class="picklist-arrow">‚ñº</span>
                    </div>
                    <div class="picklist-dropdown" id="linha-dropdown">
                        <div class="picklist-search">
                            <input type="text" placeholder="Buscar..." onkeyup="filterPicklist('linha')">
                        </div>
                        <div class="picklist-options" id="linha-options"></div>
                    </div>
                </div>
            </div>

            <div class="filter-group">
                <label>Produto:</label>
                <div class="picklist-container">
                    <div class="picklist-selected" onclick="togglePicklist('produto')">
                        <span class="picklist-text placeholder" id="produto-selected">Selecionar produtos...</span>
                        <span class="picklist-arrow">‚ñº</span>
                    </div>
                    <div class="picklist-dropdown" id="produto-dropdown">
                        <div class="picklist-search">
                            <input type="text" placeholder="Buscar..." onkeyup="filterPicklist('produto')">
                        </div>
                        <div class="picklist-options" id="produto-options"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="cards-container" id="cards"></div>

        <h2>Gr√°fico 1: Meta x Realizado (VGV)</h2>
        <div class="filters-container">
            <div class="filter-group">
                <label>Ano (Gr√°fico 1):</label>
                <div class="picklist-container">
                    <div class="picklist-selected" onclick="togglePicklist('chart1-ano')">
                        <span class="picklist-text placeholder" id="chart1-ano-selected">Selecionar anos...</span>
                        <span class="picklist-arrow">‚ñº</span>
                    </div>
                    <div class="picklist-dropdown" id="chart1-ano-dropdown">
                        <div class="picklist-search">
                            <input type="text" placeholder="Buscar..." onkeyup="filterPicklist('chart1-ano')">
                        </div>
                        <div class="picklist-options" id="chart1-ano-options"></div>
                    </div>
                </div>
            </div>

            <div class="filter-group">
                <label>M√™s (Gr√°fico 1):</label>
                <div class="picklist-container">
                    <div class="picklist-selected" onclick="togglePicklist('chart1-mes')">
                        <span class="picklist-text placeholder" id="chart1-mes-selected">Selecionar meses...</span>
                        <span class="picklist-arrow">‚ñº</span>
                    </div>
                    <div class="picklist-dropdown" id="chart1-mes-dropdown">
                        <div class="picklist-search">
                            <input type="text" placeholder="Buscar..." onkeyup="filterPicklist('chart1-mes')">
                        </div>
                        <div class="picklist-options" id="chart1-mes-options"></div>
                    </div>
                </div>
            </div>

            <div class="filter-group">
                <label>Linha (Gr√°fico 1):</label>
                <div class="picklist-container">
                    <div class="picklist-selected" onclick="togglePicklist('chart1-linha')">
                        <span class="picklist-text placeholder" id="chart1-linha-selected">Selecionar linhas...</span>
                        <span class="picklist-arrow">‚ñº</span>
                    </div>
                    <div class="picklist-dropdown" id="chart1-linha-dropdown">
                        <div class="picklist-search">
                            <input type="text" placeholder="Buscar..." onkeyup="filterPicklist('chart1-linha')">
                        </div>
                        <div class="picklist-options" id="chart1-linha-options"></div>
                    </div>
                </div>
            </div>

            <div class="filter-group">
                <label>Produto (Gr√°fico 1):</label>
                <div class="picklist-container">
                    <div class="picklist-selected" onclick="togglePicklist('chart1-produto')">
                        <span class="picklist-text placeholder" id="chart1-produto-selected">Selecionar produtos...</span>
                        <span class="picklist-arrow">‚ñº</span>
                    </div>
                    <div class="picklist-dropdown" id="chart1-produto-dropdown">
                        <div class="picklist-search">
                            <input type="text" placeholder="Buscar..." onkeyup="filterPicklist('chart1-produto')">
                        </div>
                        <div class="picklist-options" id="chart1-produto-options"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="chart1"></canvas>
        </div>

        <h2>Gr√°fico 2: % VSO por M√™s</h2>
        <div class="filters-container">
            <div class="filter-group">
                <label>Ano (Gr√°fico 2):</label>
                <div class="picklist-container">
                    <div class="picklist-selected" onclick="togglePicklist('chart2-ano')">
                        <span class="picklist-text placeholder" id="chart2-ano-selected">Selecionar anos...</span>
                        <span class="picklist-arrow">‚ñº</span>
                    </div>
                    <div class="picklist-dropdown" id="chart2-ano-dropdown">
                        <div class="picklist-search">
                            <input type="text" placeholder="Buscar..." onkeyup="filterPicklist('chart2-ano')">
                        </div>
                        <div class="picklist-options" id="chart2-ano-options"></div>
                    </div>
                </div>
            </div>

            <div class="filter-group">
                <label>M√™s (Gr√°fico 2):</label>
                <div class="picklist-container">
                    <div class="picklist-selected" onclick="togglePicklist('chart2-mes')">
                        <span class="picklist-text placeholder" id="chart2-mes-selected">Selecionar meses...</span>
                        <span class="picklist-arrow">‚ñº</span>
                    </div>
                    <div class="picklist-dropdown" id="chart2-mes-dropdown">
                        <div class="picklist-search">
                            <input type="text" placeholder="Buscar..." onkeyup="filterPicklist('chart2-mes')">
                        </div>
                        <div class="picklist-options" id="chart2-mes-options"></div>
                    </div>
                </div>
            </div>

            <div class="filter-group">
                <label>Linha (Gr√°fico 2):</label>
                <div class="picklist-container">
                    <div class="picklist-selected" onclick="togglePicklist('chart2-linha')">
                        <span class="picklist-text placeholder" id="chart2-linha-selected">Selecionar linhas...</span>
                        <span class="picklist-arrow">‚ñº</span>
                    </div>
                    <div class="picklist-dropdown" id="chart2-linha-dropdown">
                        <div class="picklist-search">
                            <input type="text" placeholder="Buscar..." onkeyup="filterPicklist('chart2-linha')">
                        </div>
                        <div class="picklist-options" id="chart2-linha-options"></div>
                    </div>
                </div>
            </div>

            <div class="filter-group">
                <label>Produto (Gr√°fico 2):</label>
                <div class="picklist-container">
                    <div class="picklist-selected" onclick="togglePicklist('chart2-produto')">
                        <span class="picklist-text placeholder" id="chart2-produto-selected">Selecionar produtos...</span>
                        <span class="picklist-arrow">‚ñº</span>
                    </div>
                    <div class="picklist-dropdown" id="chart2-produto-dropdown">
                        <div class="picklist-search">
                            <input type="text" placeholder="Buscar..." onkeyup="filterPicklist('chart2-produto')">
                        </div>
                        <div class="picklist-options" id="chart2-produto-options"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="chart2"></canvas>
        </div>

        <h2>Tabela Detalhada</h2>
        <div class="table-container">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>Ano</th>
                        <th>M√™s</th>
                        <th>Linha Produto</th>
                        <th>Produto</th>
                        <th>Meta VGV</th>
                        <th>Real VGV</th>
                        <th>Estoque VGV</th>
                        <th>% VSO</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        let rawData = [];
        let csvData = [];
        let chart1Instance = null;
        let chart2Instance = null;
        
        const mesesOrdem = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 
                           'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];

        const filters = {
            ano: [],
            mes: [],
            linha: [],
            produto: []
        };

        const chart1Filters = {
            ano: [],
            mes: [],
            linha: [],
            produto: []
        };

        const chart2Filters = {
            ano: [],
            mes: [],
            linha: [],
            produto: []
        };

        function formatBRL(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }

        function parseNumber(value) {
            if (!value) return 0;
            const str = String(value).replace(/[^\d,.-]/g, '').replace(',', '.');
            return parseFloat(str) || 0;
        }

        function processData() {
            if (!csvData || csvData.length === 0) {
                console.error('Nenhum dado dispon√≠vel para processar');
                return;
            }

            rawData = csvData.map(row => ({
                ano: String(row['ANO'] || '').trim(),
                mes: String(row['MES'] || '').trim(),
                linhaProduto: String(row['LINHA PRODUTO'] || '').trim(),
                produto: String(row['PRODUTO'] || '').trim(),
                metaVGV: parseNumber(row['META VGV']),
                realVGV: parseNumber(row['REAL VGV']),
                estoqueVGV: parseNumber(row['ESTOQUE VGV'])
            })).filter(row => row.ano && row.mes);

            initFiltersAndUI();
            applyFilters();
        }

        function initFiltersAndUI() {
            const anos = [...new Set(rawData.map(r => r.ano))].sort();
            const meses = [...new Set(rawData.map(r => r.mes))].sort((a, b) => 
                mesesOrdem.indexOf(a) - mesesOrdem.indexOf(b)
            );
            const linhas = [...new Set(rawData.map(r => r.linhaProduto))].sort();
            const produtos = [...new Set(rawData.map(r => r.produto))].sort();

            createPicklistOptions('ano', anos);
            createPicklistOptions('mes', meses);
            createPicklistOptions('linha', linhas);
            createPicklistOptions('produto', produtos);

            createPicklistOptions('chart1-ano', anos);
            createPicklistOptions('chart1-mes', meses);
            createPicklistOptions('chart1-linha', linhas);
            createPicklistOptions('chart1-produto', produtos);

            createPicklistOptions('chart2-ano', anos);
            createPicklistOptions('chart2-mes', meses);
            createPicklistOptions('chart2-linha', linhas);
            createPicklistOptions('chart2-produto', produtos);
        }

        function createPicklistOptions(filterId, values) {
            const container = document.getElementById(`${filterId}-options`);
            if (!container) return;

            container.innerHTML = `
                <div class="picklist-option all">
                    <input type="checkbox" id="${filterId}-all" onchange="toggleAll('${filterId}')">
                    <label for="${filterId}-all">Selecionar Todos</label>
                </div>
            `;

            values.forEach(value => {
                const div = document.createElement('div');
                div.className = 'picklist-option';
                div.innerHTML = `
                    <input type="checkbox" id="${filterId}-${value}" value="${value}" 
                           onchange="updateFilter('${filterId}')">
                    <label for="${filterId}-${value}">${value}</label>
                `;
                container.appendChild(div);
            });
        }

        function togglePicklist(filterId) {
            const dropdown = document.getElementById(`${filterId}-dropdown`);
            const selected = dropdown.previousElementSibling;
            const arrow = selected.querySelector('.picklist-arrow');
            
            document.querySelectorAll('.picklist-dropdown').forEach(d => {
                if (d !== dropdown) {
                    d.classList.remove('show');
                    d.previousElementSibling.classList.remove('active');
                    d.previousElementSibling.querySelector('.picklist-arrow').classList.remove('open');
                }
            });
            
            dropdown.classList.toggle('show');
            selected.classList.toggle('active');
            arrow.classList.toggle('open');
        }

        function toggleAll(filterId) {
            const allCheckbox = document.getElementById(`${filterId}-all`);
            const checkboxes = document.querySelectorAll(`#${filterId}-options input[type="checkbox"]:not(#${filterId}-all)`);
            
            checkboxes.forEach(cb => cb.checked = allCheckbox.checked);
            updateFilter(filterId);
        }

        function filterPicklist(filterId) {
            const input = document.querySelector(`#${filterId}-dropdown .picklist-search input`);
            const filter = input.value.toLowerCase();
            const options = document.querySelectorAll(`#${filterId}-options .picklist-option:not(.all)`);
            
            options.forEach(option => {
                const text = option.textContent.toLowerCase();
                option.style.display = text.includes(filter) ? '' : 'none';
            });
        }

        function updateFilter(filterId) {
            const checkboxes = document.querySelectorAll(`#${filterId}-options input[type="checkbox"]:not(#${filterId}-all)`);
            const selected = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);

            const allCheckbox = document.getElementById(`${filterId}-all`);
            allCheckbox.checked = selected.length === checkboxes.length;

            const selectedText = document.getElementById(`${filterId}-selected`);
            if (selected.length === 0) {
                selectedText.textContent = 'Nenhum selecionado';
                selectedText.classList.add('placeholder');
            } else if (selected.length === checkboxes.length) {
                selectedText.textContent = 'Todos selecionados';
                selectedText.classList.remove('placeholder');
            } else {
                selectedText.textContent = `${selected.length} selecionado(s)`;
                selectedText.classList.remove('placeholder');
            }

            const countBadge = selectedText.nextElementSibling;
            if (selected.length > 0 && !countBadge.classList.contains('picklist-arrow')) {
                countBadge.remove();
            }
            if (selected.length > 0) {
                const badge = document.createElement('span');
                badge.className = 'picklist-count';
                badge.textContent = selected.length;
                selectedText.parentElement.insertBefore(badge, selectedText.nextSibling);
            }

            if (filterId.startsWith('chart1-')) {
                const filterType = filterId.replace('chart1-', '');
                chart1Filters[filterType] = selected;
                updateChart1();
            } else if (filterId.startsWith('chart2-')) {
                const filterType = filterId.replace('chart2-', '');
                chart2Filters[filterType] = selected;
                updateChart2();
            } else {
                filters[filterId] = selected;
                applyFilters();
            }
        }

        function applyFilters() {
            const filteredData = rawData.filter(row => {
                const matchAno = filters.ano.length === 0 || filters.ano.includes(row.ano);
                const matchMes = filters.mes.length === 0 || filters.mes.includes(row.mes);
                const matchLinha = filters.linha.length === 0 || filters.linha.includes(row.linhaProduto);
                const matchProduto = filters.produto.length === 0 || filters.produto.includes(row.produto);
                
                return matchAno && matchMes && matchLinha && matchProduto;
            });

            updateCards(filteredData);
            updateTable(filteredData);
        }

        function updateCards(data) {
            const totalMeta = data.reduce((sum, row) => sum + row.metaVGV, 0);
            const totalReal = data.reduce((sum, row) => sum + row.realVGV, 0);
            const totalEstoque = data.reduce((sum, row) => sum + row.estoqueVGV, 0);
            const vso = totalEstoque > 0 ? ((totalReal / totalEstoque) * 100).toFixed(2) : 0;

            document.getElementById('cards').innerHTML = `
                <div class="card meta">
                    <h3>Meta Total (VGV)</h3>
                    <div class="value">${formatBRL(totalMeta)}</div>
                </div>
                <div class="card">
                    <h3>Realizado Total (VGV)</h3>
                    <div class="value">${formatBRL(totalReal)}</div>
                </div>
                <div class="card">
                    <h3>Estoque Total (VGV)</h3>
                    <div class="value">${formatBRL(totalEstoque)}</div>
                </div>
                <div class="card">
                    <h3>VSO Total</h3>
                    <div class="value">${vso}%</div>
                </div>
            `;
        }

        function updateTable(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = data.map(row => {
                const vso = row.estoqueVGV > 0 ? ((row.realVGV / row.estoqueVGV) * 100).toFixed(2) : 0;
                return `
                    <tr>
                        <td>${row.ano}</td>
                        <td>${row.mes}</td>
                        <td>${row.linhaProduto}</td>
                        <td>${row.produto}</td>
                        <td>${formatBRL(row.metaVGV)}</td>
                        <td>${formatBRL(row.realVGV)}</td>
                        <td>${formatBRL(row.estoqueVGV)}</td>
                        <td>${vso}%</td>
                    </tr>
                `;
            }).join('');
        }

        function updateChart1() {
            const filteredData = rawData.filter(row => {
                const matchAno = chart1Filters.ano.length === 0 || chart1Filters.ano.includes(row.ano);
                const matchMes = chart1Filters.mes.length === 0 || chart1Filters.mes.includes(row.mes);
                const matchLinha = chart1Filters.linha.length === 0 || chart1Filters.linha.includes(row.linhaProduto);
                const matchProduto = chart1Filters.produto.length === 0 || chart1Filters.produto.includes(row.produto);
                
                return matchAno && matchMes && matchLinha && matchProduto;
            });

            const dataByMonth = {};
            filteredData.forEach(row => {
                if (!dataByMonth[row.mes]) {
                    dataByMonth[row.mes] = { meta: 0, real: 0 };
                }
                dataByMonth[row.mes].meta += row.metaVGV;
                dataByMonth[row.mes].real += row.realVGV;
            });

            const labels = Object.keys(dataByMonth).sort((a, b) => 
                mesesOrdem.indexOf(a) - mesesOrdem.indexOf(b)
            );
            const metaData = labels.map(mes => dataByMonth[mes].meta);
            const realData = labels.map(mes => dataByMonth[mes].real);

            const ctx = document.getElementById('chart1');
            
            if (chart1Instance) {
                chart1Instance.destroy();
            }

            chart1Instance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Meta VGV',
                            data: metaData,
                            backgroundColor: '#F0F5CD',
                            borderColor: '#007C27',
                            borderWidth: 2
                        },
                        {
                            label: 'Real VGV',
                            data: realData,
                            backgroundColor: '#007C27',
                            borderColor: '#00512A',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Meta x Realizado (VGV)',
                            font: {
                                size: 18
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += formatBRL(context.parsed.y);
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + (value / 1000000).toFixed(1) + 'M';
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateChart2() {
            const filteredData = rawData.filter(row => {
                const matchAno = chart2Filters.ano.length === 0 || chart2Filters.ano.includes(row.ano);
                const matchMes = chart2Filters.mes.length === 0 || chart2Filters.mes.includes(row.mes);
                const matchLinha = chart2Filters.linha.length === 0 || chart2Filters.linha.includes(row.linhaProduto);
                const matchProduto = chart2Filters.produto.length === 0 || chart2Filters.produto.includes(row.produto);
                
                return matchAno && matchMes && matchLinha && matchProduto;
            });

            const dataByMonth = {};
            filteredData.forEach(row => {
                if (!dataByMonth[row.mes]) {
                    dataByMonth[row.mes] = { vendas: 0, estoque: 0 };
                }
                dataByMonth[row.mes].vendas += row.realVGV;
                dataByMonth[row.mes].estoque += row.estoqueVGV;
            });

            const labels = Object.keys(dataByMonth).sort((a, b) => 
                mesesOrdem.indexOf(a) - mesesOrdem.indexOf(b)
            );
            const vsoData = labels.map(mes => {
                const data = dataByMonth[mes];
                if (data.estoque === 0) return 0;
                return ((data.vendas / data.estoque) * 100).toFixed(2);
            });

            const ctx = document.getElementById('chart2');
            
            if (chart2Instance) {
                chart2Instance.destroy();
            }

            chart2Instance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '% VSO',
                            data: vsoData,
                            backgroundColor: '#007C27',
                            borderColor: '#00512A',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Percentual de VSO por M√™s',
                            font: {
                                size: 18
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'VSO: ' + context.parsed.y + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Fechar dropdown ao clicar fora
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.picklist-container')) {
                document.querySelectorAll('.picklist-dropdown').forEach(dropdown => {
                    dropdown.classList.remove('show');
                    dropdown.previousElementSibling.classList.remove('active');
                    dropdown.previousElementSibling.querySelector('.picklist-arrow').classList.remove('open');
                });
            }
        });

        window.addEventListener('load', processData);
    </script>

    <script>
        (function() {
            try {
                if (window.Chart) {
                    Chart.defaults.elements = Chart.defaults.elements || {}
                    Chart.defaults.elements.bar = Chart.defaults.elements.bar || {}
                    Chart.defaults.elements.bar.backgroundColor = '#007C27';
                    Chart.defaults.elements.bar.borderColor = '#007C27';
                    Chart.defaults.elements.bar.borderWidth = 1;
                    Chart.defaults.color = '#00512A';
                }
            } catch(e) { }
        })();
    </script>

    <script>
        // === SISTEMA DE ATUALIZA√á√ÉO AUTOM√ÅTICA DO GOOGLE SHEETS ===
        const SHEETS_PRIMARY_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSju9gP6RC3zHnt5qHlUPuqJMKCqr2TIQ0y7RIhEhGkuUZLGjzKCp6M0kYnqmkLEKJQXNEZycZgCSv6/pub?gid=0&single=true&output=csv";
        const SHEETS_FALLBACK_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSju9gP6RC3zHnt5qHlUPuqJMKCqr2TIQ0y7RIhEhGkuUZLGjzKCp6M0kYnqmkLEKJQXNEZycZgCSv6/gviz/tq?tqx=out:csv&gid=0";
        
        window.DEBUG_SHEETS = { started: false, finished: false, rows: 0, header: [], urlTried: [], error: null };

        function updateLastUpdateTime() {
            const now = new Date();
            const formatted = now.toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById('lastUpdate').textContent = `√öltima atualiza√ß√£o: ${formatted}`;
        }

        function csvToArray(text) {
            const rows = [];
            let field = '', row = [], inQuotes = false;
            for (let i = 0; i < text.length; i++) {
                const c = text[i];
                if (c === '"') {
                    const next = text[i+1];
                    if (next === '"') { 
                        field += '"'; 
                        i++; 
                    } else { 
                        inQuotes = !inQuotes; 
                    }
                } else if (c === ',' && !inQuotes) {
                    row.push(field); 
                    field = '';
                } else if ((c === '\n' || c === '\r') && !inQuotes) {
                    if (c === '\r' && text[i+1] === '\n') { 
                        i++; 
                    }
                    row.push(field); 
                    rows.push(row); 
                    row = []; 
                    field = '';
                } else {
                    field += c;
                }
            }
            if (field.length > 0 || row.length > 0) { 
                row.push(field); 
                rows.push(row); 
            }
            return rows;
        }

        async function fetchCSV(url) {
            const u = url + (url.includes('?') ? '&' : '?') + "cb=" + Date.now();
            window.DEBUG_SHEETS.urlTried.push(u);
            const resp = await fetch(u, { cache: 'no-store' });
            if (!resp.ok) throw new Error("HTTP " + resp.status);
            return await resp.text();
        }

        function showDebug(msg, type = 'info') {
            let bar = document.getElementById("gsheets-debug");
            if (!bar) {
                bar = document.createElement("div");
                bar.id = "gsheets-debug";
                const container = document.querySelector(".container");
                if (container.firstChild) {
                    container.insertBefore(bar, container.firstChild.nextSibling);
                } else {
                    container.appendChild(bar);
                }
            }
            
            bar.className = type === 'success' ? 'success' : (type === 'error' ? 'error' : '');
            
            const icon = type === 'success' ? '‚úÖ' : (type === 'error' ? '‚ùå' : '‚ÑπÔ∏è');
            bar.innerHTML = `<span class="status-icon">${icon}</span><div>${msg}</div>`;
        }

        async function loadSheetsWithFallback() {
            window.DEBUG_SHEETS.started = true;
            window.DEBUG_SHEETS.urlTried = [];
            
            try {
                let text = null;
                try {
                    showDebug('Carregando dados da planilha...', 'info');
                    text = await fetchCSV(SHEETS_PRIMARY_CSV);
                } catch (e1) {
                    console.warn("Primary CSV failed, trying fallback:", e1);
                    showDebug('Tentando URL alternativa...', 'info');
                    text = await fetchCSV(SHEETS_FALLBACK_CSV);
                }
                
                const rows = csvToArray(text);
                if (!rows || rows.length === 0) throw new Error("CSV vazio");
                
                const header = rows[0].map(h => String(h || '').trim());
                const dataRows = rows.slice(1).filter(r => r.some(x => String(x).trim() !== ''));
                
                window.DEBUG_SHEETS.header = header;
                window.DEBUG_SHEETS.rows = dataRows.length;
                csvData = dataRows.map(r => Object.fromEntries(header.map((h, i) => [h, r[i]])));
                window.DEBUG_SHEETS.finished = true;
                
                showDebug(
                    `<strong>Dados carregados com sucesso!</strong><br>` +
                    `Colunas: ${header.join(', ')}<br>` +
                    `Total de linhas: <strong>${dataRows.length}</strong>`,
                    'success'
                );
                
                updateLastUpdateTime();
                
            } catch (err) {
                window.DEBUG_SHEETS.error = (err && err.message) ? err.message : String(err);
                throw err;
            }
        }

        function callInitsSafely() {
            setTimeout(() => {
                try {
                    if (typeof processData === 'function') processData();
                } catch (e) {
                    console.error("Erro ao processar dados:", e);
                    showDebug(`Erro ao processar dados: ${e.message}`, 'error');
                }
            }, 50);
        }

        async function manualRefresh() {
            const btn = document.getElementById('refreshBtn');
            const icon = btn.querySelector('.refresh-icon');
            
            btn.classList.add('loading');
            btn.disabled = true;
            
            try {
                await loadSheetsWithFallback();
                callInitsSafely();
            } catch (err) {
                showDebug(
                    `<strong>Erro ao carregar planilha:</strong> ${err?.message || err}<br>` +
                    `<small>URLs tentadas: ${window.DEBUG_SHEETS.urlTried.join(', ')}</small>`,
                    'error'
                );
                console.error("Erro ao atualizar:", err);
            } finally {
                btn.classList.remove('loading');
                btn.disabled = false;
            }
        }

        // Carregamento inicial
        window.addEventListener('DOMContentLoaded', () => {
            const fileProtocol = (location.protocol === 'file:');
            if (fileProtocol) {
                showDebug(
                    '‚ö†Ô∏è <strong>Modo Local Detectado</strong><br>' +
                    'Voc√™ est√° abrindo o arquivo localmente (file://). ' +
                    'Para melhor funcionamento, use um servidor web (ex: Live Server no VS Code).',
                    'info'
                );
            }
            
            loadSheetsWithFallback()
                .then(() => {
                    callInitsSafely();
                })
                .catch(err => {
                    showDebug(
                        `<strong>Erro ao carregar a planilha:</strong> ${err?.message || err}<br>` +
                        `<small>URLs tentadas:<br>${window.DEBUG_SHEETS.urlTried.join('<br>')}</small>`,
                        'error'
                    );
                    console.error("Erro Sheets:", err);
                });
        });
    </script>
</body>
</html>
