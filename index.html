<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Relat√≥rio Meta x Realizado - VSO</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: #f0f8f0;
    color: #0a4d3a;
}

.container {
    max-width: 1600px;
    margin: 0 auto;
    padding: 24px;
}

.header {
    background: white;
    border-radius: 12px;
    padding: 32px;
    margin-bottom: 24px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

h1 {
    color: #0a4d3a;
    font-size: 28px;
    font-weight: 700;
    margin-bottom: 24px;
}

.filters-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 16px;
}

.filter-group {
    position: relative;
}

.filter-label {
    font-weight: 600;
    margin-bottom: 8px;
    color: #1a5f4a;
    font-size: 14px;
    display: block;
}

.picklist-trigger {
    width: 100%;
    padding: 10px 36px 10px 12px;
    border: 1px solid #66ffaa;
    border-radius: 8px;
    background: white;
    cursor: pointer;
    font-size: 14px;
    color: #0a4d3a;
    text-align: left;
    transition: all 0.2s;
    position: relative;
}

.picklist-trigger:hover {
    border-color: #1a5f4a;
}

.picklist-trigger.active {
    border-color: #66ffaa;
    box-shadow: 0 0 0 3px rgba(102, 255, 170, 0.1);
}

.picklist-trigger::after {
    content: '‚ñº';
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 10px;
    color: #1a5f4a;
}

.picklist-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    margin-top: 4px;
    background: white;
    border: 1px solid #66ffaa;
    border-radius: 8px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    max-height: 280px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
}

.picklist-dropdown.active {
    display: block;
}

.picklist-search {
    padding: 8px 12px;
    border-bottom: 1px solid #66ffaa;
    position: sticky;
    top: 0;
    background: white;
    z-index: 1;
}

.picklist-search input {
    width: 100%;
    padding: 6px 10px;
    border: 1px solid #66ffaa;
    border-radius: 6px;
    font-size: 13px;
}

.picklist-options {
    padding: 4px;
}

.picklist-option {
    padding: 8px 12px;
    cursor: pointer;
    border-radius: 6px;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: background 0.15s;
}

.picklist-option:hover {
    background: #f0f8f0;
}

.picklist-option input[type="checkbox"] {
    width: 16px;
    height: 16px;
    cursor: pointer;
}

.picklist-selected-count {
    display: inline-block;
    background: #66ffaa;
    color: #0a4d3a;
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 10px;
    margin-left: 8px;
    font-weight: 600;
}

.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
}

.metric-card {
    background: white;
    border-radius: 12px;
    padding: 28px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    min-height: 150px;
    min-width: 220px;
    max-width: 100%;
    overflow: hidden;
}

.metric-card.vso-tri {
    border-left: 4px solid #1a5f4a;
}

.metric-card.vso-ano {
    border-left: 4px solid #66ffaa;
    background: linear-gradient(135deg, #f0f8f0, white);
}

.metric-label {
    font-size: 12px;
    font-weight: 600;
    color: #1a5f4a;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
}

.metric-value {
    font-size: 28px !important;
    font-weight: 700;
    color: #0a4d3a;
    margin-bottom: 6px;
    white-space: normal;
    word-wrap: break-word;
    word-break: break-word;
    line-height: 1.15;
}

.metric-value.large {
    font-size: 34px !important;
}

.metric-subtitle {
    font-size: 11px;
    color: #1a5f4a;
    line-height: 1.3;
}

.metric-bar {
    width: 100%;
    height: 6px;
    background: #f0f8f0;
    border-radius: 3px;
    margin-top: 12px;
    overflow: hidden;
}

.metric-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #1a5f4a, #66ffaa);
    border-radius: 3px;
    transition: width 0.6s ease;
}

.table-section {
    background: white;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.table-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.table-title {
    font-size: 20px;
    font-weight: 700;
    color: #0a4d3a;
}

.table-count {
    font-size: 14px;
    color: #1a5f4a;
    background: #f0f8f0;
    padding: 6px 12px;
    border-radius: 6px;
}

.table-wrapper {
    overflow: auto;
    border-radius: 8px;
    border: 1px solid #66ffaa;
}

.table-section.expandable .table-wrapper {
    max-height: 60vh;
}

table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    min-width: 1200px;
}

thead {
    background: #f0f8f0;
}

th {
    padding: 14px 16px;
    text-align: left;
    font-weight: 600;
    font-size: 13px;
    color: #0a4d3a;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 2px solid #66ffaa;
    white-space: nowrap;
    position: sticky;
    top: 0;
    background: #f0f8f0;
    z-index: 6;
    background-clip: padding-box;
}

td {
    padding: 14px 16px;
    border-bottom: 1px solid #f0f8f0;
    font-size: 14px;
    white-space: nowrap;
    background-clip: padding-box;
}

tbody tr:hover {
    background: #f0f8f0;
}

.sticky-col {
    position: sticky;
    background: #fff;
    z-index: 2;
}

.sticky-col.col-1 { left: 0; z-index: 5; box-shadow: 2px 0 0 #e8f4ec; }
.sticky-col.col-2 { left: var(--col1, 220px); z-index: 4; box-shadow: 2px 0 0 #e8f4ec; }
.sticky-col.col-3 { left: calc((var(--col1, 220px) + var(--col2, 240px))); z-index: 3; box-shadow: 2px 0 0 #e8f4ec; }

.vso-badge {
    display: inline-flex;
    align-items: center;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 13px;
    font-weight: 600;
}

.vso-high { background: #66ffaa; color: #0a4d3a; }
.vso-medium { background: #1a5f4a; color: white; }
.vso-low { background: #0a4d3a; color: white; }

.loading, .no-data {
    text-align: center;
    padding: 60px;
    color: #1a5f4a;
}

.currency {
    font-variant-numeric: tabular-nums;
}

.charts-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
    gap: 20px;
    margin-bottom: 24px;
}

.chart-card {
    background: white;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.chart-title {
    font-size: 18px;
    font-weight: 700;
    color: #0a4d3a;
}

.chart-selector {
    padding: 6px 12px;
    border: 1px solid #66ffaa;
    border-radius: 6px;
    font-size: 13px;
    background: white;
    color: #0a4d3a;
    cursor: pointer;
    font-weight: 500;
}

canvas {
    max-height: 350px;
}

.download-btn {
    padding: 10px 20px;
    background: linear-gradient(135deg, #1a5f4a, #66ffaa);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.download-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.15);
}

.table-section.expandable .expand-btn {
    padding: 8px 14px;
    border: 1px solid #66ffaa;
    background: #ffffff;
    color: #0a4d3a;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all .2s;
}

.table-section.expandable .expand-btn:hover {
    border-color: #1a5f4a;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
}

.table-section.expanded {
    position: fixed;
    inset: 0;
    background: #ffffff;
    z-index: 9998;
    margin: 0 !important;
    border-radius: 0 !important;
    padding: 16px !important;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.table-section.expanded .table-wrapper {
    flex: 1;
    height: auto;
    max-height: none;
    overflow: auto;
}

.table-section tfoot#totals-footer tr td,
.table-section tfoot#totals-footer tr th {
    background: #f0f8f0;
    position: sticky;
    bottom: 0;
    z-index: 7;
    border-top: 2px solid #66ffaa;
    font-weight: 700;
}

@media (max-width: 768px) {
    .container {
        padding: 12px;
    }

    h1 {
        font-size: 20px;
        text-align: center;
    }

    .metrics-grid {
        grid-template-columns: 1fr !important;
    }

    .metric-card {
        min-width: 100% !important;
        padding: 20px;
        margin-bottom: 12px;
    }

    .metric-value {
        font-size: 22px !important;
        text-align: center;
    }

    .metric-value.large {
        font-size: 26px !important;
    }

    .filters-grid {
        grid-template-columns: 1fr !important;
    }

    .charts-section {
        grid-template-columns: 1fr !important;
    }
}
</style>
</head>
<body>
<div id="badgeLoaded" style="position:fixed;top:8px;right:8px;background:#0ea5e9;color:#fff;padding:8px 12px;border-radius:8px;z-index:9999;font-family:Inter,system-ui">Carregando...</div>

<script>
var allData = [];
(function() {
  try {
    var csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSju9gP6RC3zHnt5qHlUPuqJMKCqr2TIQ0y7RIhEhGkuUZLGjzKCp6M0kYnqmkLEKJQXNEZycZgCSv6/pub?gid=0&single=true&output=csv";
    var req = new XMLHttpRequest();
    req.open('GET', csvUrl, false);
    req.send(null);
    if (req.status === 200) {
      var parsed = Papa.parse(req.responseText, {
        header: true,
        dynamicTyping: true,
        skipEmptyLines: true,
      });
      function t(s) { return (s||"").toString().trim(); }
      allData = parsed.data.map(function(r) {
        var o = {};
        Object.keys(r).forEach(function(k) {
          o[t(k)] = r[k];
        });
        function num(x) {
          var v = (typeof x === 'string') ? x.replace(/\./g,'').replace(',', '.') : x;
          v = parseFloat(v);
          return isFinite(v) ? v : 0;
        }
        return {
          "Empresa": o["Empresa"] ?? o["EMPRESA"] ?? o["empresa"] ?? "",
          "M√™s": o["M√™s"] ?? o["Mes"] ?? o["M√äS"] ?? o["MES"] ?? "",
          "Ano": num(o["Ano"] ?? o["ANO"] ?? o["ano"]),
          "Linha de Produto": o["Linha de Produto"] ?? o["LINHA DE PRODUTO"] ?? o["Linha"] ?? "",
          "Produto": o["Produto"] ?? o["PRODUTO"] ?? "",
          " Meta VGV ": num(o[" Meta VGV "] ?? o["Meta VGV"] ?? o["META VGV"] ?? o["Meta_VGV"]),
          " Real VGV ": num(o[" Real VGV "] ?? o["Real VGV"] ?? o["REAL VGV"] ?? o["Real_VGV"]),
          "Meta Qtd": num(o["Meta Qtd"] ?? o["META QTD"] ?? o["Meta_Qtd"]),
          "Real Qtd": num(o["Real Qtd"] ?? o["REAL QTD"] ?? o["Real_Qtd"]),
          "Estoque VGV": num(o["Estoque VGV"] ?? o["ESTOQUE VGV"] ?? o["Estoque_VGV"]),
          "Estoque Qtd": num(o["Estoque Qtd"] ?? o["ESTOQUE QTD"] ?? o["Estoque_Qtd"]),
          "% VSO": num(o["% VSO"] ?? o["%VSO"] ?? o["VSO"] ?? o["% vso"] ?? 0)
        };
      });
      console.log("‚úÖ Planilha carregada:", allData.length, "linhas");
    }
  } catch(e) {
    console.error("‚ùå Erro ao carregar CSV:", e);
  }
})();
</script>

<script>
(function(){
  const MESES = ["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
  
  function ultimoMesComInfoSum(data, ano, campo){
    for (let i=MESES.length-1; i>=0; i--){
      const m = MESES[i];
      const soma = data.filter(r => String(r["Ano"])===String(ano) && r["M√™s"]===m)
                       .reduce((s,r)=> s + (+r[campo]||0), 0);
      if (soma > 0) return {mes:m, soma};
    }
    return {mes:null, soma:0};
  }
  
  function ordMeses(arr){
    return arr.slice().sort((a,b)=>MESES.indexOf(a)-MESES.indexOf(b));
  }
  
  window.getEstoqueQtdForFilters = function(selectedAno, selectedMeses, extraFilterFn){
    const base = Array.isArray(window.allData) ? window.allData : [];
    const data = extraFilterFn ? base.filter(extraFilterFn) : base;
    
    if (selectedMeses && selectedMeses.length >= 1){
      const ord = ordMeses(selectedMeses);
      
      if (ord.length === 1) {
        const mes = ord[0];
        if (selectedAno) {
          return data.filter(r => String(r["Ano"])===String(selectedAno) && r["M√™s"]===mes)
                     .reduce((s,r)=> s + (+r["Estoque Qtd"]||0), 0);
        } else {
          return data.filter(r => r["M√™s"]===mes)
                     .reduce((s,r)=> s + (+r["Estoque Qtd"]||0), 0);
        }
      } else {
        const ultimoMes = ord[ord.length - 1];
        const idxUltimo = MESES.indexOf(ultimoMes);
        const idxSubsequente = idxUltimo + 1;
        
        if (idxSubsequente < 12) {
          const mesSubsequente = MESES[idxSubsequente];
          if (selectedAno) {
            return data.filter(r => String(r["Ano"])===String(selectedAno) && r["M√™s"]===mesSubsequente)
                       .reduce((s,r)=> s + (+r["Estoque Qtd"]||0), 0);
          } else {
            return data.filter(r => r["M√™s"]===mesSubsequente)
                       .reduce((s,r)=> s + (+r["Estoque Qtd"]||0), 0);
          }
        } else {
          if (selectedAno) {
            const anoSeguinte = selectedAno + 1;
            return data.filter(r => String(r["Ano"])===String(anoSeguinte) && r["M√™s"]==="Janeiro")
                       .reduce((s,r)=> s + (+r["Estoque Qtd"]||0), 0);
          } else {
            const anos = Array.from(new Set(data.map(r=>r["Ano"]).filter(x=>x!=null))).sort((a,b)=>b-a);
            for (const ano of anos) {
              const estoque = data.filter(r => String(r["Ano"])===String(ano) && r["M√™s"]==="Janeiro")
                                  .reduce((s,r)=> s + (+r["Estoque Qtd"]||0), 0);
              if (estoque > 0) return estoque;
            }
            return 0;
          }
        }
      }
    }
    
    if (selectedAno){
      const {soma} = ultimoMesComInfoSum(data, selectedAno, "Estoque Qtd");
      return soma;
    } else {
      const anos = Array.from(new Set(data.map(r=>r["Ano"]).filter(x=>x!=null)));
      const total = anos.reduce((acc, ano)=> acc + ultimoMesComInfoSum(data, ano, "Estoque Qtd").soma, 0);
      return total;
    }
  };
  
  window.getEstoqueVGVForFilters = function(selectedAno, selectedMeses, extraFilterFn){
    const base = Array.isArray(window.allData) ? window.allData : [];
    const data = extraFilterFn ? base.filter(extraFilterFn) : base;
    
    if (selectedMeses && selectedMeses.length >= 1){
      const ord = ordMeses(selectedMeses);
      
      if (ord.length === 1) {
        const mes = ord[0];
        if (selectedAno) {
          return data.filter(r => String(r["Ano"])===String(selectedAno) && r["M√™s"]===mes)
                     .reduce((s,r)=> s + (+r["Estoque VGV"]||0), 0);
        } else {
          return data.filter(r => r["M√™s"]===mes)
                     .reduce((s,r)=> s + (+r["Estoque VGV"]||0), 0);
        }
      } else {
        const ultimoMes = ord[ord.length - 1];
        const idxUltimo = MESES.indexOf(ultimoMes);
        const idxSubsequente = idxUltimo + 1;
        
        if (idxSubsequente < 12) {
          const mesSubsequente = MESES[idxSubsequente];
          if (selectedAno) {
            return data.filter(r => String(r["Ano"])===String(selectedAno) && r["M√™s"]===mesSubsequente)
                       .reduce((s,r)=> s + (+r["Estoque VGV"]||0), 0);
          } else {
            return data.filter(r => r["M√™s"]===mesSubsequente)
                       .reduce((s,r)=> s + (+r["Estoque VGV"]||0), 0);
          }
        } else {
          if (selectedAno) {
            const anoSeguinte = selectedAno + 1;
            return data.filter(r => String(r["Ano"])===String(anoSeguinte) && r["M√™s"]==="Janeiro")
                       .reduce((s,r)=> s + (+r["Estoque VGV"]||0), 0);
          } else {
            const anos = Array.from(new Set(data.map(r=>r["Ano"]).filter(x=>x!=null))).sort((a,b)=>b-a);
            for (const ano of anos) {
              const estoque = data.filter(r => String(r["Ano"])===String(ano) && r["M√™s"]==="Janeiro")
                                  .reduce((s,r)=> s + (+r["Estoque VGV"]||0), 0);
              if (estoque > 0) return estoque;
            }
            return 0;
          }
        }
      }
    }
    
    if (selectedAno){
      const {soma} = ultimoMesComInfoSum(data, selectedAno, "Estoque VGV");
      return soma;
    } else {
      const anos = Array.from(new Set(data.map(r=>r["Ano"]).filter(x=>x!=null)));
      const total = anos.reduce((acc, ano)=> acc + ultimoMesComInfoSum(data, ano, "Estoque VGV").soma, 0);
      return total;
    }
  };
  
  console.log("‚úÖ Fun√ß√µes de c√°lculo de estoque carregadas");
})();
</script>

<div class="container">
<div class="header">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
<h1>üìä An√°lise Meta x Realizado - VSO</h1>
<div style="display: flex; gap: 12px;">
<button class="download-btn" onclick="downloadReport()">
üíæ Baixar Relat√≥rio
</button>
</div>
</div>

<div class="filters-grid">
<div class="filter-group">
<label class="filter-label">üè¢ Empresa</label>
<button class="picklist-trigger" onclick="togglePicklist('empresa')">
Selecione<span id="empresa-count"></span>
</button>
<div class="picklist-dropdown" id="picklist-empresa">
<div class="picklist-search">
<input oninput="filterPicklist('empresa', this.value)" placeholder="Buscar..." type="text"/>
</div>
<div class="picklist-options" id="options-empresa"></div>
</div>
</div>

<div class="filter-group">
<label class="filter-label">üìÖ M√™s</label>
<button class="picklist-trigger" onclick="togglePicklist('mes')">
Selecione<span id="mes-count"></span>
</button>
<div class="picklist-dropdown" id="picklist-mes">
<div class="picklist-search">
<input oninput="filterPicklist('mes', this.value)" placeholder="Buscar..." type="text"/>
</div>
<div class="picklist-options" id="options-mes"></div>
</div>
</div>

<div class="filter-group">
<label class="filter-label">üìÜ Ano</label>
<button class="picklist-trigger" onclick="togglePicklist('ano')">
Selecione<span id="ano-count"></span>
</button>
<div class="picklist-dropdown" id="picklist-ano">
<div class="picklist-search">
<input oninput="filterPicklist('ano', this.value)" placeholder="Buscar..." type="text"/>
</div>
<div class="picklist-options" id="options-ano"></div>
</div>
</div>

<div class="filter-group">
<label class="filter-label">üì¶ Linha de Produto</label>
<button class="picklist-trigger" onclick="togglePicklist('linha')">
Selecione<span id="linha-count"></span>
</button>
<div class="picklist-dropdown" id="picklist-linha">
<div class="picklist-search">
<input oninput="filterPicklist('linha', this.value)" placeholder="Buscar..." type="text"/>
</div>
<div class="picklist-options" id="options-linha"></div>
</div>
</div>

<div class="filter-group">
<label class="filter-label">üè∑Ô∏è Produto</label>
<button class="picklist-trigger" onclick="togglePicklist('produto')">
Selecione<span id="produto-count"></span>
</button>
<div class="picklist-dropdown" id="picklist-produto">
<div class="picklist-search">
<input oninput="filterPicklist('produto', this.value)" placeholder="Buscar..." type="text"/>
</div>
<div class="picklist-options" id="options-produto"></div>
</div>
</div>
</div>
</div>

<div class="metrics-grid" id="metricsGrid">
<div class="loading">Carregando dados...</div>
</div>

<div class="charts-section">
<div class="chart-card">
<div class="chart-header">
<h3 class="chart-title">üìä Meta x Realizado</h3>
<select class="chart-selector" id="chartType1" onchange="updateCharts()">
<option value="mes">Por M√™s</option>
<option value="linha">Por Linha de Produto</option>
<option value="produto">Por Produto</option>
</select>
</div>
<canvas id="chartMetaRealizado"></canvas>
</div>

<div class="chart-card">
<div class="chart-header">
<h3 class="chart-title">üìà % VSO</h3>
<select class="chart-selector" id="chartType2" onchange="updateCharts()">
<option value="mes">Por M√™s</option>
<option value="linha">Por Linha de Produto</option>
<option value="produto">Por Produto</option>
</select>
</div>
<canvas id="chartVSO"></canvas>
</div>
</div>

<div class="table-section expandable">
<div class="table-header">
<h2 class="table-title">Quadro Resumo Detalhado</h2>
<div style="display: flex; gap: 12px; align-items: center;">
<span class="table-count" id="recordCount">0 registros</span>
<button class="expand-btn" onclick="toggleExpand(this)">Expandir</button>
</div>
</div>
<div class="table-wrapper">
<table data-totals-injected="true">
<thead>
<tr>
<th class="sticky-col col-1">Empresa</th>
<th class="sticky-col col-2">Linha de Produto</th>
<th class="sticky-col col-3">Produto</th>
<th>Meta VGV</th>
<th>Real VGV</th>
<th>Meta Qtd</th>
<th>Real Qtd</th>
<th>Estoque VGV</th>
<th>Estoque Qtd</th>
<th>% VSO</th>
</tr>
</thead>
<tbody id="tableBody">
<tr><td class="loading" colspan="10">Carregando...</td></tr>
</tbody>
<tfoot id="totals-footer"><tr><th colspan="10">TOTAL</th></tr></tfoot>
</table>
</div>
</div>
</div>

<script>
const selectedFilters = {
    empresa: new Set(),
    mes: new Set(),
    ano: new Set(),
    linha: new Set(),
    produto: new Set()
};

function initializeFilters() {
    const empresas = [...new Set(allData.map(d => d.Empresa))].filter(Boolean).sort();
    const ordemMeses = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 
                       'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
    const mesesUnicos = [...new Set(allData.map(d => d.M√™s))].filter(Boolean);
    const meses = ordemMeses.filter(m => mesesUnicos.includes(m));
    const anos = [...new Set(allData.map(d => d.Ano))].filter(Boolean).sort((a, b) => b - a);
    const linhas = [...new Set(allData.map(d => d['Linha de Produto']))].filter(Boolean).sort();
    const produtos = [...new Set(allData.map(d => d.Produto))].filter(Boolean).sort();

    populatePicklist('empresa', empresas);
    populatePicklist('mes', meses);
    populatePicklist('ano', anos);
    populatePicklist('linha', linhas);
    populatePicklist('produto', produtos);
}

function populatePicklist(id, items) {
    const container = document.getElementById(`options-${id}`);
    container.innerHTML = items.map(item => `
        <label class="picklist-option">
            <input type="checkbox" value="${item}" onchange="updateFilter('${id}', '${item}', this.checked)">
            <span>${item}</span>
        </label>
    `).join('');
}

function togglePicklist(id) {
    const dropdown = document.getElementById(`picklist-${id}`);
    const trigger = dropdown.previousElementSibling;
    
    document.querySelectorAll('.picklist-dropdown').forEach(d => {
        if (d !== dropdown) {
            d.classList.remove('active');
            d.previousElementSibling.classList.remove('active');
        }
    });
    
    dropdown.classList.toggle('active');
    trigger.classList.toggle('active');
}

function filterPicklist(id, searchTerm) {
    const options = document.querySelectorAll(`#options-${id} .picklist-option`);
    const term = searchTerm.toLowerCase();
    
    options.forEach(option => {
        const text = option.textContent.toLowerCase();
        option.style.display = text.includes(term) ? 'flex' : 'none';
    });
}

function updateFilter(id, value, checked) {
    if (checked) {
        selectedFilters[id].add(value);
    } else {
        selectedFilters[id].delete(value);
    }
    
    updateSelectedCount(id);
    updateDashboard();
}

function updateSelectedCount(id) {
    const count = selectedFilters[id].size;
    const countEl = document.getElementById(`${id}-count`);
    
    if (count > 0) {
        countEl.innerHTML = `<span class="picklist-selected-count">${count}</span>`;
    } else {
        countEl.innerHTML = '';
    }
}

function filterData() {
    return allData.filter(row => {
        return (selectedFilters.empresa.size === 0 || selectedFilters.empresa.has(row.Empresa)) &&
               (selectedFilters.mes.size === 0 || selectedFilters.mes.has(row.M√™s)) &&
               (selectedFilters.ano.size === 0 || selectedFilters.ano.has(String(row.Ano))) &&
               (selectedFilters.linha.size === 0 || selectedFilters.linha.has(row['Linha de Produto'])) &&
               (selectedFilters.produto.size === 0 || selectedFilters.produto.has(row.Produto));
    });
}

function updateDashboard() {
    const filtered = filterData();
    updateMetrics(filtered);
    updateTable(filtered);
    
    if (document.getElementById('chartMetaRealizado') && document.getElementById('chartVSO')) {
        updateCharts();
    }
}

function updateMetrics(data) {
    const metaVGV = data.reduce((sum, r) => sum + (r[' Meta VGV '] || 0), 0);
    const realVGV = data.reduce((sum, r) => sum + (r[' Real VGV '] || 0), 0);
    
    const selectedAnoStrs = Array.from(selectedFilters.ano);
    const selectedAno = selectedAnoStrs.length===1 ? parseInt(selectedAnoStrs[0]) : null;
    const selectedMeses = Array.from(selectedFilters.mes);
    const extraFilterFn = (r)=> (
        (selectedFilters.empresa.size===0 || selectedFilters.empresa.has(r.Empresa)) &&
        (selectedFilters.linha.size===0 || selectedFilters.linha.has(r['Linha de Produto'])) &&
        (selectedFilters.produto.size===0 || selectedFilters.produto.has(r['Produto']))
    );
    
    // Estoque para os cards Meta/Real/Estoque (l√≥gica antiga)
    const estoqueVGV = (typeof getEstoqueVGVForFilters==='function')
        ? getEstoqueVGVForFilters(selectedAno, selectedMeses, extraFilterFn)
        : data.reduce((sum, r) => sum + (r['Estoque VGV'] || 0), 0);
    
    // VSO GERAL - Nova L√≥gica
    let vsoGeralNumerador = realVGV;
    let vsoGeralDenominador = 0;
    
    if (selectedMeses.length === 0) {
        // SEM FILTRO: √öltimo estoque dispon√≠vel
        vsoGeralDenominador = (typeof getEstoqueVGVForFilters==='function')
            ? getEstoqueVGVForFilters(selectedAno, selectedMeses, extraFilterFn)
            : data.reduce((sum, r) => sum + (r['Estoque VGV'] || 0), 0);
    } else {
        // COM FILTRO DE M√äS(ES): Soma dos estoques de TODOS os meses filtrados
        const MESES = ["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
        const mesesOrdenados = selectedMeses.slice().sort((a,b) => MESES.indexOf(a) - MESES.indexOf(b));
        
        mesesOrdenados.forEach(mes => {
            const estoqueDoMes = data.filter(r => 
                r["M√™s"] === mes && 
                (!selectedAno || String(r["Ano"]) === String(selectedAno))
            ).reduce((sum, r) => sum + (r['Estoque VGV'] || 0), 0);
            vsoGeralDenominador += estoqueDoMes;
        });
    }
    
    const vsoGeral = vsoGeralDenominador > 0 ? (vsoGeralNumerador / vsoGeralDenominador * 100) : 0;
    const atingimentoMeta = metaVGV > 0 ? (realVGV / metaVGV * 100) : 0;

    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
    console.log('üîç DEBUG VSO GERAL - NOVA L√ìGICA');
    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
    console.log('üìÖ Filtros Aplicados:');
    console.log('   ‚Ä¢ Meses:', selectedMeses.length > 0 ? selectedMeses.join(', ') : '‚ùå Nenhum');
    console.log('   ‚Ä¢ Ano:', selectedAno || '‚ùå Nenhum');
    console.log('');
    console.log('‚öôÔ∏è L√≥gica VSO GERAL:');
    if (selectedMeses.length === 0) {
        console.log('   üìå SEM FILTRO DE M√äS');
        console.log('   ‚ûú Vendas: Soma de todas as vendas dos dados filtrados');
        console.log('   ‚ûú Estoque: √öLTIMO M√äS RECENTE com estoque dispon√≠vel');
    } else if (selectedMeses.length === 1) {
        console.log('   üìå FILTRO DE 1 M√äS: ' + selectedMeses[0]);
        console.log('   ‚ûú Vendas: Vendas do m√™s ' + selectedMeses[0]);
        console.log('   ‚ûú Estoque: Estoque do m√™s ' + selectedMeses[0]);
        console.log('   ‚ûú F√≥rmula: Vendas[' + selectedMeses[0] + '] / Estoque[' + selectedMeses[0] + ']');
    } else {
        const MESES_ORD = ["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
        const mesesOrdenados = selectedMeses.slice().sort((a,b) => MESES_ORD.indexOf(a) - MESES_ORD.indexOf(b));
        console.log('   üìå FILTRO DE M√öLTIPLOS MESES: ' + mesesOrdenados.join(', '));
        console.log('   ‚ûú Vendas: SOMA de vendas de TODOS os meses do per√≠odo');
        console.log('   ‚ûú Estoque: SOMA de estoques de TODOS os meses do per√≠odo');
        console.log('   ‚ûú F√≥rmula: Œ£Vendas[' + mesesOrdenados.join('+') + '] / Œ£Estoque[' + mesesOrdenados.join('+') + ']');
    }
    console.log('');
    console.log('üìä Resultados:');
    console.log('   üí∞ Vendas (Real VGV): R$ ' + vsoGeralNumerador.toLocaleString('pt-BR', {maximumFractionDigits: 0}));
    console.log('   üì¶ Estoque Total: R$ ' + vsoGeralDenominador.toLocaleString('pt-BR', {maximumFractionDigits: 0}));
    console.log('   üìà VSO GERAL: ' + vsoGeral.toFixed(2) + '%');
    console.log('   üßÆ C√°lculo: ' + vsoGeralNumerador.toFixed(0) + ' √∑ ' + vsoGeralDenominador.toFixed(0) + ' √ó 100');
    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');

    document.getElementById('metricsGrid').innerHTML = `
        <div class="metric-card">
            <div class="metric-label">Meta VGV</div>
            <div class="metric-value currency">R$ ${formatMoney(metaVGV)}</div>
            <div class="metric-subtitle">Valor planejado</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Real VGV</div>
            <div class="metric-value currency">R$ ${formatMoney(realVGV)}</div>
            <div class="metric-subtitle">${atingimentoMeta.toFixed(1)}% da meta</div>
            <div class="metric-bar">
                <div class="metric-bar-fill" style="width: ${Math.min(atingimentoMeta, 100)}%"></div>
            </div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Estoque VGV</div>
            <div class="metric-value currency">R$ ${formatMoney(estoqueVGV)}</div>
            <div class="metric-subtitle">Valor em estoque</div>
        </div>
        <div class="metric-card vso-ano">
            <div class="metric-label">VSO Geral</div>
            <div class="metric-value large">${vsoMedio.toFixed(1)}%</div>
            <div class="metric-subtitle">
                Vendas: R$ ${formatMoneyShort(realVGV)}<br>
                Estoque: R$ ${formatMoneyShort(estoqueVGV)}<br>
                <small style="opacity: 0.7;">
                    ${selectedMeses.length === 0 
                        ? 'Estoque: √öltimo m√™s dispon√≠vel' 
                        : selectedMeses.length === 1
                        ? 'Estoque: Do pr√≥prio m√™s'
                        : 'Estoque: M√™s subsequente ao per√≠odo'}
                </small>
            </div>
            <div class="metric-bar">
                <div class="metric-bar-fill" style="width: ${Math.min(vsoMedio, 100)}%"></div>
            </div>
        </div>
    `;
}

function updateTable(data) {
    const tbody = document.getElementById('tableBody');
    
    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="no-data">Nenhum registro encontrado</td></tr>';
        document.getElementById('recordCount').textContent = '0 registros';
        return;
    }

    const selectedAnoStrs = Array.from(selectedFilters.ano);
    const selectedAno = selectedAnoStrs.length === 1 ? parseInt(selectedAnoStrs[0]) : null;
    const selectedMeses = Array.from(selectedFilters.mes);

    const groupedData = {};
    
    data.forEach(row => {
        const key = `${row.Empresa}-${row['Linha de Produto']}-${row.Produto}`;
        
        if (!groupedData[key]) {
            groupedData[key] = {
                Empresa: row.Empresa,
                'Linha de Produto': row['Linha de Produto'],
                Produto: row.Produto,
                metaVGV: 0,
                realVGV: 0,
                metaQtd: 0,
                realQtd: 0,
                estoqueVGV: 0,
                estoqueQtd: 0,
                rawData: []
            };
        }
        
        groupedData[key].metaVGV += row[' Meta VGV '] || 0;
        groupedData[key].realVGV += row[' Real VGV '] || 0;
        groupedData[key].metaQtd += row['Meta Qtd'] || 0;
        groupedData[key].realQtd += row['Real Qtd'] || 0;
        groupedData[key].rawData.push(row);
    });

    Object.keys(groupedData).forEach(key => {
        const group = groupedData[key];
        const productData = group.rawData;
        
        const extraFilterFn = (r) => (
            r.Empresa === group.Empresa &&
            r['Linha de Produto'] === group['Linha de Produto'] &&
            r.Produto === group.Produto
        );
        
        if (typeof getEstoqueVGVForFilters === 'function') {
            group.estoqueVGV = getEstoqueVGVForFilters(selectedAno, selectedMeses, extraFilterFn) || 0;
        } else {
            group.estoqueVGV = productData.reduce((sum, r) => sum + (r['Estoque VGV'] || 0), 0);
        }
        
        if (typeof getEstoqueQtdForFilters === 'function') {
            group.estoqueQtd = getEstoqueQtdForFilters(selectedAno, selectedMeses, extraFilterFn) || 0;
        } else {
            group.estoqueQtd = productData.reduce((sum, r) => sum + (r['Estoque Qtd'] || 0), 0);
        }
        
        delete group.rawData;
    });

    const groupedArray = Object.values(groupedData);
    document.getElementById('recordCount').textContent = `${groupedArray.length} produtos`;

    tbody.innerHTML = groupedArray.map(row => {
        const vso = row.estoqueVGV > 0 ? (row.realVGV / row.estoqueVGV * 100) : 0;
        const vsoClass = vso >= 50 ? 'vso-high' : vso >= 20 ? 'vso-medium' : 'vso-low';

        return `
            <tr>
                <td class="sticky-col col-1">${row.Empresa || '-'}</td>
                <td class="sticky-col col-2">${row['Linha de Produto'] || '-'}</td>
                <td class="sticky-col col-3">${row.Produto || '-'}</td>
                <td class="currency">R$ ${formatMoney(row.metaVGV)}</td>
                <td class="currency">R$ ${formatMoney(row.realVGV)}</td>
                <td>${row.metaQtd}</td>
                <td>${row.realQtd}</td>
                <td class="currency">R$ ${formatMoney(row.estoqueVGV)}</td>
                <td>${row.estoqueQtd}</td>
                <td><span class="vso-badge ${vsoClass}">${vso.toFixed(1)}%</span></td>
            </tr>
        `;
    }).join('');
    
    computeTotals();
}

let chartMetaRealizado = null;
let chartVSO = null;

function updateCharts() {
    const filtered = filterData();
    
    if (!document.getElementById('chartMetaRealizado') || !document.getElementById('chartVSO')) {
        return;
    }
    
    const type1 = document.getElementById('chartType1').value;
    const type2 = document.getElementById('chartType2').value;

    updateMetaRealizadoChart(filtered, type1);
    updateVSOChart(filtered, type2);
}

function updateMetaRealizadoChart(data, groupBy) {
    const ctx = document.getElementById('chartMetaRealizado');
    
    if (chartMetaRealizado) {
        chartMetaRealizado.destroy();
    }

    const grouped = groupData(data, groupBy);
    const labels = Object.keys(grouped);
    const metaData = labels.map(label => grouped[label].meta);
    const realData = labels.map(label => grouped[label].real);

    chartMetaRealizado = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Meta VGV',
                    data: metaData,
                    backgroundColor: 'rgba(26, 95, 74, 0.7)',
                    borderColor: '#1a5f4a',
                    borderWidth: 2
                },
                {
                    label: 'Real VGV',
                    data: realData,
                    backgroundColor: 'rgba(102, 255, 170, 0.7)',
                    borderColor: '#66ffaa',
                    borderWidth: 2
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': R$ ' + formatMoney(context.parsed.y);
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    }
                },
                y: {
                    beginAtZero: true,
                    grid: {
                        display: false
                    },
                    ticks: {
                        callback: function(value) {
                            return 'R$ ' + formatMoneyShort(value);
                        }
                    }
                }
            }
        }
    });
}

function updateVSOChart(data, groupBy) {
    const ctx = document.getElementById('chartVSO');
    
    if (chartVSO) {
        chartVSO.destroy();
    }

    const grouped = groupData(data, groupBy);
    const labels = Object.keys(grouped);
    const vsoData = labels.map(label => {
        const group = grouped[label];
        return group.estoque > 0 ? (group.real / group.estoque * 100) : 0;
    });

    chartVSO = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: '% VSO',
                data: vsoData,
                backgroundColor: vsoData.map(v => 
                    v >= 50 ? 'rgba(102, 255, 170, 0.7)' : 
                    v >= 20 ? 'rgba(26, 95, 74, 0.7)' : 
                    'rgba(10, 77, 58, 0.7)'
                ),
                borderColor: vsoData.map(v => 
                    v >= 50 ? '#66ffaa' : 
                    v >= 20 ? '#1a5f4a' : 
                    '#0a4d3a'
                ),
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return '% VSO: ' + context.parsed.y.toFixed(1) + '%';
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    }
                },
                y: {
                    beginAtZero: true,
                    max: 100,
                    grid: {
                        display: false
                    },
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            }
        }
    });
}

function groupData(data, groupBy) {
    const grouped = {};
    const ordemMeses = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 
                       'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];

    data.forEach(row => {
        let key;
        if (groupBy === 'mes') {
            key = row.M√™s;
        } else if (groupBy === 'linha') {
            key = row['Linha de Produto'];
        } else {
            key = row.Produto;
        }

        if (!key) return;

        if (!grouped[key]) {
            grouped[key] = { meta: 0, real: 0, estoque: 0 };
        }

        grouped[key].meta += row[' Meta VGV '] || 0;
        grouped[key].real += row[' Real VGV '] || 0;
        grouped[key].estoque += row['Estoque VGV'] || 0;
    });

    if (groupBy === 'mes') {
        const sorted = {};
        ordemMeses.forEach(mes => {
            if (grouped[mes]) {
                sorted[mes] = grouped[mes];
            }
        });
        return sorted;
    } else if (groupBy === 'produto') {
        const sorted = Object.entries(grouped)
            .sort((a, b) => b[1].real - a[1].real);
        const result = {};
        sorted.forEach(([key, value]) => {
            result[key] = value;
        });
        return result;
    } else {
        const sorted = Object.keys(grouped).sort();
        const result = {};
        sorted.forEach(key => {
            result[key] = grouped[key];
        });
        return result;
    }
}

function formatMoney(value) {
    return new Intl.NumberFormat('pt-BR', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(value);
}

function formatMoneyShort(value) {
    if (value >= 1000000) {
        return (value / 1000000).toFixed(1) + 'M';
    } else if (value >= 1000) {
        return (value / 1000).toFixed(1) + 'K';
    }
    return value.toFixed(0);
}

function downloadReport() {
    const wb = XLSX.utils.book_new();
    const filtered = filterData();
    
    const ws = XLSX.utils.json_to_sheet(filtered);
    XLSX.utils.book_append_sheet(wb, ws, "Dados");
    
    const metaVGV = filtered.reduce((sum, r) => sum + (r[' Meta VGV '] || 0), 0);
    const realVGV = filtered.reduce((sum, r) => sum + (r[' Real VGV '] || 0), 0);
    const estoqueVGV = filtered.reduce((sum, r) => sum + (r['Estoque VGV'] || 0), 0);
    const vsoMedio = estoqueVGV > 0 ? (realVGV / estoqueVGV * 100) : 0;
    const atingimentoMeta = metaVGV > 0 ? (realVGV / metaVGV * 100) : 0;
    
    const resumo = [
        { Metrica: 'Meta VGV', Valor: metaVGV },
        { Metrica: 'Real VGV', Valor: realVGV },
        { Metrica: 'Estoque VGV', Valor: estoqueVGV },
        { Metrica: '% VSO M√©dio', Valor: vsoMedio.toFixed(1) + '%' },
        { Metrica: '% Atingimento Meta', Valor: atingimentoMeta.toFixed(1) + '%' }
    ];
    
    const wsResumo = XLSX.utils.json_to_sheet(resumo);
    XLSX.utils.book_append_sheet(wb, wsResumo, "Resumo");
    
    XLSX.writeFile(wb, 'relatorio-meta-realizado.xlsx');
}

function toggleExpand(btn) {
    const section = btn.closest('.table-section');
    const isExpanded = section.classList.toggle('expanded');
    btn.textContent = isExpanded ? 'Fechar' : 'Expandir';
    document.body.style.overflow = isExpanded ? 'hidden' : '';
}

function computeTotals() {
    const table = document.querySelector('table[data-totals-injected="true"]');
    if (!table) return;
    
    const tbody = table.querySelector('tbody');
    if (!tbody) return;
    
    const rows = Array.from(tbody.rows);
    let totalMetaVGV = 0, totalRealVGV = 0;
    let totalMetaQtd = 0, totalRealQtd = 0;
    let totalEstoqueVGV = 0, totalEstoqueQtd = 0;
    
    rows.forEach(row => {
        if (row.style.display === 'none') return;
        const cells = row.cells;
        if (cells.length < 10) return;
        
        totalMetaVGV += parseFloat(cells[3].textContent.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
        totalRealVGV += parseFloat(cells[4].textContent.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
        totalMetaQtd += parseFloat(cells[5].textContent) || 0;
        totalRealQtd += parseFloat(cells[6].textContent) || 0;
        totalEstoqueVGV += parseFloat(cells[7].textContent.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
        totalEstoqueQtd += parseFloat(cells[8].textContent) || 0;
    });
    
    const selectedAnoStrs = Array.from(selectedFilters.ano);
    const selectedAno = selectedAnoStrs.length === 1 ? parseInt(selectedAnoStrs[0]) : null;
    const selectedMeses = Array.from(selectedFilters.mes);
    
    if (typeof getEstoqueVGVForFilters === 'function') {
        const extraFilterFn = (r)=> (
            (selectedFilters.empresa.size===0 || selectedFilters.empresa.has(r.Empresa)) &&
            (selectedFilters.linha.size===0 || selectedFilters.linha.has(r['Linha de Produto'])) &&
            (selectedFilters.produto.size===0 || selectedFilters.produto.has(r['Produto']))
        );
        totalEstoqueVGV = getEstoqueVGVForFilters(selectedAno, selectedMeses, extraFilterFn);
    }
    
    if (typeof getEstoqueQtdForFilters === 'function') {
        const extraFilterFn = (r)=> (
            (selectedFilters.empresa.size===0 || selectedFilters.empresa.has(r.Empresa)) &&
            (selectedFilters.linha.size===0 || selectedFilters.linha.has(r['Linha de Produto'])) &&
            (selectedFilters.produto.size===0 || selectedFilters.produto.has(r['Produto']))
        );
        totalEstoqueQtd = getEstoqueQtdForFilters(selectedAno, selectedMeses, extraFilterFn);
    }
    
    const vsoTotal = totalEstoqueVGV > 0 ? (totalRealVGV / totalEstoqueVGV * 100) : 0;
    
    const tfoot = table.querySelector('tfoot#totals-footer');
    if (!tfoot) return;
    
    tfoot.innerHTML = `
        <tr>
            <th class="sticky-col col-1">TOTAL</th>
            <th class="sticky-col col-2"></th>
            <th class="sticky-col col-3"></th>
            <td class="currency">R$ ${formatMoney(totalMetaVGV)}</td>
            <td class="currency">R$ ${formatMoney(totalRealVGV)}</td>
            <td>${totalMetaQtd}</td>
            <td>${totalRealQtd}</td>
            <td class="currency">R$ ${formatMoney(totalEstoqueVGV)}</td>
            <td>${totalEstoqueQtd}</td>
            <td><span class="vso-badge ${vsoTotal >= 50 ? 'vso-high' : vsoTotal >= 20 ? 'vso-medium' : 'vso-low'}">${vsoTotal.toFixed(1)}%</span></td>
        </tr>
    `;
}

document.addEventListener('click', (e) => {
    if (!e.target.closest('.filter-group')) {
        document.querySelectorAll('.picklist-dropdown').forEach(d => {
            d.classList.remove('active');
            d.previousElementSibling.classList.remove('active');
        });
    }
});

// Inicializar dashboard
document.addEventListener('DOMContentLoaded', function(){
    const badge = document.getElementById('badgeLoaded');
    if (badge) {
        badge.textContent = allData && allData.length ? (allData.length + ' registros carregados') : '0 registros';
        setTimeout(() => badge.remove(), 4000);
    }
    
    initializeFilters();
    updateDashboard();
    setTimeout(() => {
        updateCharts();
    }, 50);
});
</script>

<script>
(function(){
    function findResumoDetalhadoTable() {
        const sections = document.querySelectorAll('.table-section');
        for (const sec of sections) {
            const title = sec.querySelector('.table-title');
            if (title && /quadro\s+resumo\s+detalhado/i.test(title.textContent || '')) {
                const tbl = sec.querySelector('table');
                if (tbl) return tbl;
            }
        }
        return document.querySelector('.table-section table') || document.querySelector('table');
    }

    function measureColWidths(tbl) {
        if (!tbl) return {w1:220, w2:240, w3:260};
        const rows = Array.from(tbl.querySelectorAll('tr'));
        let w = [0,0,0];
        rows.slice(0, Math.min(rows.length, 30)).forEach(tr => {
            const cells = tr.children;
            for (let i = 0; i < 3; i++) {
                const cell = cells[i];
                if (!cell) continue;
                const rect = cell.getBoundingClientRect();
                const cw = Math.max(rect.width, 160);
                if (cw > w[i]) w[i] = cw;
            }
        });
        w = w.map((v, i) => v || [220,240,260][i]);
        return {w1: Math.ceil(w[0]), w2: Math.ceil(w[1]), w3: Math.ceil(w[2])};
    }

    function applyStickyCols(tbl) {
        if (!tbl) return;
        const wrapper = tbl.closest('.table-wrapper') || tbl.parentElement;
        if (wrapper) wrapper.style.overflow = 'auto';

        const rows = tbl.querySelectorAll('tr');
        rows.forEach(tr => {
            const cells = tr.children;
            if (cells[0]) cells[0].classList.add('sticky-col', 'col-1');
            if (cells[1]) cells[1].classList.add('sticky-col', 'col-2');
            if (cells[2]) cells[2].classList.add('sticky-col', 'col-3');
        });

        const {w1, w2, w3} = measureColWidths(tbl);
        tbl.style.setProperty('--col1', w1 + 'px');
        tbl.style.setProperty('--col2', w2 + 'px');
        tbl.style.setProperty('--col3', w3 + 'px');

        const setMinWidth = (selector, w) => {
            tbl.querySelectorAll(selector).forEach(el => {
                el.style.minWidth = w + 'px';
                el.style.width = w + 'px';
                el.style.maxWidth = w + 'px';
            });
        };
        setMinWidth('.col-1', w1);
        setMinWidth('.col-2', w2);
        setMinWidth('.col-3', w3);
    }

    function initFreeze() {
        const tbl = findResumoDetalhadoTable();
        if (!tbl) return;
        applyStickyCols(tbl);
    }

    window.addEventListener('load', initFreeze);
    window.addEventListener('resize', () => {
        const tbl = findResumoDetalhadoTable();
        if (!tbl) return;
        tbl.style.removeProperty('--col1');
        tbl.style.removeProperty('--col2');
        tbl.style.removeProperty('--col3');
        const rows = tbl.querySelectorAll('tr');
        rows.forEach(tr => {
            const cells = tr.children;
            if (cells[0]) cells[0].style = '';
            if (cells[1]) cells[1].style = '';
            if (cells[2]) cells[2].style = '';
        });
        applyStickyCols(tbl);
    });
})();
</script>

<script>
(function(){
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSju9gP6RC3zHnt5qHlUPuqJMKCqr2TIQ0y7RIhEhGkuUZLGjzKCp6M0kYnqmkLEKJQXNEZycZgCSv6/pub?gid=0&single=true&output=csv";

    function normalizeHeader(h){
        if (!h) return h;
        let k = String(h).replace(/\s+/g,' ').trim();
        const map = {
            "Meta VGV": " Meta VGV ",
            "Real VGV": " Real VGV ",
            "Meta Qtd": "Meta Qtd",
            "Real Qtd": "Real Qtd",
            "Estoque VGV": "Estoque VGV",
            "Estoque Qtd": "Estoque Qtd",
            "Linha": "Linha de Produto",
            "Linha de Produto": "Linha de Produto",
            "Mes": "M√™s",
            "M√™s": "M√™s",
            "Ano": "Ano",
            "Empresa": "Empresa",
            "Produto": "Produto",
            "% VSO": "% VSO"
        };
        return map[k] || k;
    }

    function fmtMes(valor){
        const nomes = ["","Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
        if (valor==null || valor==="") return valor;
        const n = Number(valor);
        if (!Number.isNaN(n) && n>=1 && n<=12) return nomes[n];
        const s = String(valor).trim();
        const idx = nomes.findIndex(x => x.toLowerCase() == s.toLowerCase());
        return idx>0 ? nomes[idx] : s;
    }

    async function carregar(){
        try {
            const resp = await fetch(CSV_URL + "&_cb=" + Date.now(), { cache: "no-store" });
            if(!resp.ok) throw new Error("HTTP " + resp.status);
            const csv = await resp.text();
            const parsed = Papa.parse(csv, { header: true, dynamicTyping: false, skipEmptyLines: true });
            const rows = parsed.data.map(row => {
                const out = {};
                Object.keys(row).forEach(key => out[ normalizeHeader(key) ] = row[key]);
                if (out["Ano"]!==undefined) out["Ano"] = Number(String(out["Ano"]).replace(/\D/g,'')) || null;
                if (out["M√™s"]!==undefined) out["M√™s"] = fmtMes(out["M√™s"]);
                [" Meta VGV "," Real VGV ","Meta Qtd","Real Qtd","Estoque VGV","Estoque Qtd","% VSO"].forEach(k=>{
                    if (out[k]!==undefined) {
                        const v = (''+out[k]).trim();
                        const n = Number(v.replace(/\./g,'').replace(',','.'));
                        out[k] = isNaN(n) ? (Number(v) || 0) : n;
                    }
                });
                return out;
            });

            console.log("‚úÖ [AUTO-LOADER] Linhas carregadas:", rows.length);
            window.allData = rows;

            const badge = document.getElementById("badgeLoaded");
            if (badge){
                const d=new Date(), pad=n=>String(n).padStart(2,'0');
                badge.textContent = "Atualizado em " + d.getFullYear()+"-"+pad(d.getMonth()+1)+"-"+pad(d.getDate())+" "+pad(d.getHours())+":"+pad(d.getMinutes())+":"+pad(d.getSeconds())+" ‚Ä¢ "+rows.length+" linhas";
                badge.style.background = rows.length ? "#0ea5e9" : "#dc2626";
            }
            
            if (typeof initializeFilters === 'function') initializeFilters();
            if (typeof updateDashboard === 'function') updateDashboard();
            setTimeout(() => {
                if (typeof updateCharts === 'function') updateCharts();
            }, 100);
        } catch(e){
            console.error("‚ùå [AUTO-LOADER] Erro:", e);
            const badge = document.getElementById("badgeLoaded");
            if (badge){ badge.textContent = "Erro ao carregar: " + e.message; badge.style.background = "#dc2626"; }
        }
    }

    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', carregar);
    else carregar();
    setInterval(carregar, 5*60*1000);
})();
</script>

</body>
</html>
